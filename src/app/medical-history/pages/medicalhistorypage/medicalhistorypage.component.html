<div class="container" *ngIf="!isLoading">
  <div style="margin-bottom: 20px;">
    <button routerLink="/homeDoctor" class="back-btn">
      ← Back to Home
    </button>
  </div>

  <div class="profile">
    <img *ngIf="patient" [src]="patient.image || 'https://via.placeholder.com/150'" alt="Patient photo" class="avatar" />
    <div class="info">
      <h2>{{ patient.firstName }} {{ patient.lastName }}</h2>
      <p>{{ patient.age }} years • {{ patient.gender }}</p>
    </div>
  </div>

  <div class="main-data">
    <h3>Clinical Data</h3>
    <ul>
      <li><strong>Weight: </strong>
        <span *ngIf="!isEditMode">{{ medicalHistory?.weight || 'N/A' }} Kg</span>
        <input *ngIf="isEditMode" type="number" [formControl]="weightControl" />
      </li>
      <li><strong>Physycal Test Control:</strong>
        <span *ngIf="!isEditMode">{{ medicalHistory?.physical_test || 'N/A' }}</span>
        <input *ngIf="isEditMode" type="text" [formControl]="physicalTestControl" />
      </li>
      <li><strong>Blood Type:</strong> {{ patient.typeofblood || 'Unknown' }}</li>
      <li><strong>Allergies:</strong>
        <span *ngIf="!isEditMode">{{ medicalHistory?.personal_background || 'None' }}</span>
        <input *ngIf="isEditMode" type="text" [formControl]="personalBackgroundControl" />
      </li>
    </ul>
  </div>

  <div class="history-section">
    <h3>Medical History</h3>

    <div class="history-card">
      <h4>Reason for Consultation</h4>
      <span *ngIf="!isEditMode">{{ medicalHistory?.reason || 'Not provided' }}</span>
      <input *ngIf="isEditMode" type="text" [formControl]="reasonControl" />
    </div>

    <div class="history-card">
      <h4>Antecedents</h4>
      <span *ngIf="!isEditMode">{{ medicalHistory?.family_background || 'None reported' }}</span>
      <input *ngIf="isEditMode" type="text" [formControl]="familyBackgroundControl" />
    </div>

    <div class="history-card">
      <h4>Exams</h4>
      <ul *ngIf="medicalHistory?.medical_exams?.length; else noExams">
        <li *ngFor="let exam of medicalHistory?.medical_exams">{{ exam }}</li>
      </ul>
      <ng-template #noExams><p>No exams recorded.</p></ng-template>
    </div>

    <div class="history-card">
      <h4>External Reports</h4>
      <ul *ngIf="!isEditMode && medicalHistory?.external_reports?.length; else noReports">
        <li *ngFor="let report of medicalHistory?.external_reports">{{ report }}</li>
      </ul>
      <textarea *ngIf="isEditMode" rows="3" [formControl]="externalReportsControl"></textarea>
      <ng-template #noReports><p>No external reports uploaded.</p></ng-template>
    </div>

    <div class="history-card">
      <h4>Treatments</h4>
      <ul *ngIf="!isEditMode && medicalHistory?.treatment_and_medication?.length; else noTreatments">
        <li *ngFor="let treatment of medicalHistory?.treatment_and_medication">
          {{ treatment.drug_name }} – {{ treatment.quantity }} {{ treatment.concentration }} – {{ treatment.frequency }} for {{ treatment.duration }}
        </li>
      </ul>
      <textarea *ngIf="isEditMode" rows="3" [formControl]="treatmentAndMedicationControl"></textarea>
      <ng-template #noTreatments><p>No treatments prescribed.</p></ng-template>
    </div>
  </div>

  <div class="actions" style="margin-top: 20px;">
    <button (click)="toggleEdit()" *ngIf="!isEditMode">Edit</button>
    <button (click)="saveChanges()" *ngIf="isEditMode">Save</button>
  </div>
</div>

<div *ngIf="isLoading" class="loading">Loading patient data...</div>
